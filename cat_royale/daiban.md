ç›®æ ‡ï¼š
è®©æœ¬æ¸¸æˆAä¸ºHostï¼ŒBä¸ºClientï¼Œæ˜¯Açš„Host Authorityã€‚

ç°åœ¨æƒ…å†µï¼šè¿™ä¸ªè¿ç§»è®¡åˆ’å®Œæˆäº†ä¸€äº›ï¼Œä½†æ˜¯æ›´å¤šæ²¡å®Œæˆï¼Œæ‰€ä»¥è¯´ç°åœ¨è¿™ä¸ªä¸€äº›åœ°æ–¹æ¯”å¦‚è¯´clientè¢«æŒ¡äº†ï¼Œä½†æ˜¯hoståˆæ²¡æœ‰æ‰§è¡Œã€‚ä½ è¦æ‰«æè¿™äº›é—®é¢˜ï¼Œç„¶åè¿›è¡Œè§£å†³ã€‚å¦‚ä¸‹çš„è®¡åˆ’ä¹¦ä»…ä¾›å‚è€ƒï¼ä»…ä¾›å‚è€ƒï¼ä»…ä¾›å‚è€ƒï¼è¯·ä½ æ ¹æ®å®é™…æƒ…å†µï¼Œç°åœ¨å·²ç»æ”¹çš„æƒ…å†µï¼Œåœ¨æœ€å°åŒ–ä»£ç æ”¹åŠ¨çš„æƒ…å†µä¸‹å®Œæˆã€‚

å®Œæˆåï¼Œè¯·æŠŠæœ¬åœ°çš„ä¸€äº›åŠŸèƒ½å’Œäº‘ç«¯çš„æ ¸å¯¹ï¼Œç¡®ä¿æœ¬åœ°çš„æ¯”å¦‚è¯´abilityï¼Œæ¯”å¦‚è¯´åŠŸèƒ½ï¼Œå’Œaç«¯bç«¯éƒ½æ˜¯ä¸€è‡´çš„ã€‚

Cat Royale æˆ˜æ–—ç³»ç»Ÿï¼šé€»è¾‘è¿ç§»è®¡åˆ’ä¹¦ï¼ˆPlan Documentï¼‰
ğŸ¯ ç›®æ ‡ï¼ˆGoalï¼‰

å°†å½“å‰åˆ†æ•£åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸Šçš„æˆ˜æ–—é€»è¾‘ï¼Œç»Ÿä¸€è¿ç§»åˆ° Host ç«¯ï¼ˆæƒå¨ç«¯, authoritative hostï¼‰ æ‰§è¡Œï¼Œå®ç°ï¼š

æˆ˜æ–—åŒæ­¥ä¸€è‡´æ€§ 100%ï¼ˆno desyncï¼‰

å®¢æˆ·ç«¯ä¸å†æ‹¥æœ‰ä»»ä½•é€»è¾‘æƒåŠ›ï¼ˆä¸èƒ½éšä¾¿ deploy/attack/damageï¼‰

æ‰€æœ‰æ”»å‡»ã€ç§»åŠ¨ã€è¡€é‡ã€æ­»äº¡ã€æ¸¸æˆç»“æŸéƒ½ç”± Host å†³å®šå¹¶åŒæ­¥

B å®¢æˆ·ç«¯å¯ä»¥æ­£å¸¸è¿›æ”» Aï¼ˆHost ä»£æ›¿ B æ‰§è¡Œæ‰€æœ‰æ”»å‡»ï¼‰

ä¸ºæœªæ¥**è¿ç§»åˆ°æœåŠ¡å™¨ï¼ˆHeadless Host æ¨¡å¼ï¼‰**åšå¥½æ¶æ„

æœ€ç»ˆæ•ˆæœï¼š

A ç«¯æ˜¯å”¯ä¸€çš„ã€Œæ¸¸æˆæ¨¡æ‹Ÿå™¨ã€
B ç«¯åªæ˜¯çº¯å±•ç¤ºï¼ˆviewerï¼‰+ è¾“å…¥ï¼ˆintentï¼‰
æœåŠ¡å™¨åªè´Ÿè´£â€œè½¬å‘æ¶ˆæ¯ï¼Œä¸åšé€»è¾‘â€

è¿™æ˜¯ Clash Royaleã€Brawl Stars ä»¥åŠå¤§éƒ¨åˆ†å®æ—¶ PvP æ¸¸æˆçš„æ ‡å‡†åšæ³•ã€‚

ğŸ“Œ å½“å‰æƒ…å†µï¼ˆRealistic Current Stateï¼‰

ä¸‹é¢æ˜¯ä½ å½“å‰ç³»ç»Ÿçš„çœŸå®ç»“æ„ï¼ˆåŸºäºä½ ç»™çš„æ—¥å¿— + æˆ‘åˆ†æå‡ºçš„æ¶æ„ï¼‰ï¼š

âœ” 1. æœåŠ¡å™¨ä¸å‚ä¸è®¡ç®—

battle_ws.py åªåšè½¬å‘ï¼Œä¸åšéªŒè¯ã€ä¸ç®— HPã€ä¸åˆ¤æ–­æ­»äº¡ã€ä¸åˆ¤èƒœè´Ÿ

âœ” 2. Aï¼ˆHostï¼‰å’Œ Bï¼ˆClientï¼‰éƒ½åœ¨æ‰§è¡Œè‡ªå·±çš„æˆ˜æ–—é€»è¾‘

è¡¨ç°ä¸ºï¼š

æ¯ä¸€ç«¯éƒ½åœ¨è·‘ tower scan attack

æ¯ä¸€ç«¯éƒ½åœ¨è·‘ç§»åŠ¨ movers

æ¯ä¸€ç«¯éƒ½åœ¨å°è¯•è°ƒç”¨ applyDamage

ä½ åˆšåˆšæŠŠ B çš„ applyDamage ç¦äº†ï¼Œæ‰€ä»¥ B æ‰“ä¸äº† Aã€‚

âœ” 3. B çš„æ£‹å­æœ‰æ—¶ç”± B è‡ªå·±ç”Ÿæˆï¼ˆåŒ spawnï¼‰

å¯¼è‡´ï¼š

B çš„æ£‹å­æ²¡æœ‰æ³¨å†Œåˆ° host çš„ tower_scan æˆ–ç§»åŠ¨ç®¡ç†å™¨

host æ ¹æœ¬ä¸çŸ¥é“æœ‰è¿™æš B çš„æ£‹å­

B çœ‹è§è‡ªå·±æœ‰æ”»å‡»ï¼Œä½† host çœ‹ä¸åˆ° â†’ B æ‰“ä¸åŠ¨ host

âœ” 4. ruler_move_request æ²¡æœ‰åœ¨ host å±‚éªŒè¯

æ‰€ä»¥ï¼š

ruler ç§»åŠ¨åœ¨ B ç«¯è‡ªå·±è·‘ â†’ åŒæ­¥é”™è¯¯

elixir åœ¨ B è‡ªå·±æ‰£ â†’ ä¸ä¸€è‡´

host ä¸çŸ¥é“ B çš„ ruler èµ°åˆ°äº†å“ªé‡Œ

âœ” 5. death/game_over åªåœ¨æœ¬åœ°è§¦å‘ï¼Œæ— ç½‘ç»œåŒæ­¥

é€ æˆï¼š

A çœ‹åˆ° game overï¼Œä½† B ç»§ç»­ç©è‡ªå·±é‚£å¥— local åŠ¨ç”»

æˆ– B çœ‹åˆ° A æ­»äº†ä½† host ä¸çŸ¥é“ â†’ æ°¸è¿œä¸ä¼šç»“æŸ

âœ” æ€»ç»“ï¼šç°åœ¨æ˜¯ã€ŒåŒæ¨¡æ‹Ÿå™¨ã€æ¨¡å¼

Host å’Œ Client éƒ½åœ¨æ¨¡æ‹Ÿæ¸¸æˆ â†’ desync æ˜¯å¿…ç„¶ã€‚

æˆ‘ä»¬è¦æ”¹æˆâ€œåªæœ‰ Host æ¨¡æ‹Ÿï¼ŒClient åªæ˜¾ç¤ºâ€ã€‚

ğŸ§­ å¤§è®¡åˆ’ï¼ˆMaster Planï¼‰

ç›®æ ‡æ˜¯ä¸€å¥è¯ï¼š

æŠŠæ‰€æœ‰æ¸¸æˆé€»è¾‘ä»æµè§ˆå™¨çš„æ¯ä¸ªç«¯ â†’ æ”¶æ‹¢åˆ° Host æµè§ˆå™¨å”¯ä¸€è¿è¡Œã€‚Client åªè´Ÿè´£è¾“å…¥ã€å±•ç¤ºï¼Œä¸å‡†è‡ªå·±ç®—é€»è¾‘ã€‚

æ•´ä¸ªè®¡åˆ’åˆ† 3 ä¸ªé˜¶æ®µï¼š

Phase 1ï¼šHost æƒå¨åŒ–ï¼ˆAuthoritative Hostï¼‰ğŸ’ï¼ˆå½“å‰é˜¶æ®µï¼‰

è®© Host æˆä¸ºå”¯ä¸€â€œæ¸¸æˆå¼•æ“â€ï¼ŒClient å®Œå…¨ä¸ç®—é€»è¾‘ã€‚

å†…å®¹åŒ…æ‹¬ï¼š

æ‰€æœ‰æ£‹å­åªç”± Host deployPiece() åˆ›å»º

æ‰€æœ‰æ”»å‡»åªåœ¨ Host æ‰§è¡Œ

æ‰€æœ‰ applyDamage åªåœ¨ Host æ‰§è¡Œ

æ‰€æœ‰æ­»äº¡åªåœ¨ Host è§¦å‘

æ‰€æœ‰ game_over åªåœ¨ Host åˆ¤æ–­

Client ç«¯å®Œå…¨ä¸æ‰§è¡Œä»»ä½• mover/tower/attack é€»è¾‘

Phase 2ï¼šHost â†’ æ‰€æœ‰äººåŒæ­¥ï¼ˆState Replicationï¼‰ğŸ’ 

åœ¨ Host æ‰§è¡Œå®ŒåŠ¨ä½œåï¼š

HPã€æ­»äº¡ã€spawnã€ç§»åŠ¨ã€timerã€elixir
â†’ å…¨éƒ½ç”¨ state_update å¹¿æ’­å‡ºå»
â†’ æ‰€æœ‰äººæ ¹æ® state_update æ¥åˆ·æ–° UI

è¿™å°±æ˜¯â€œclient-side visual / host-side simulation architectureâ€çš„å…¸å‹åšæ³•ã€‚

Step 1ï¼šç¦æ­¢ Client åœ¨æœ¬åœ° deployPiece
è¦å®ç°ï¼š

B ç‚¹å‡»æ ¼å­æ—¶ï¼Œæœ¬åœ°ä¸èƒ½ç”Ÿæˆæ£‹å­

åªå…è®¸ Host ç”Ÿæˆæ£‹å­ï¼ˆé€šè¿‡ state_update: spawnï¼‰

æ–¹æ³•ï¼š

åœ¨ deployPiece() é¡¶éƒ¨åŠ ï¼š

if (!opts.fromNetwork && window.IS_HOST !== true) {
  console.warn("Client should not deploy locally");
  return;
}


å®Œæˆæ ‡å¿—ï¼š

B ç‚¹å‡»ä¸ä¼šæœ¬åœ°ä¸‹å­

Host ä¼šæ”¶åˆ° deploy_request

Host ä¼šä¸‹å­

B ç«¯åªä¼šæ”¶åˆ° spawn â†’ fromNetwork:true â†’ åˆ›å»ºæ£‹å­

Step 2ï¼šç¦æ­¢ Client æ‰§è¡Œæ”»å‡»/ç§»åŠ¨é€»è¾‘

æ‰€æœ‰æ”»å‡»å¾ªç¯åŠ ï¼š

if (!window.IS_HOST) return;


åŒ…æ‹¬ï¼š

scanTowerAttacks

startShouterAttack

startFighterMove

startRulerMove

squirmer_attack

aggressive_tower_attack

solid_tower_attack

å®Œæˆæ ‡å¿—ï¼š

B çš„ attack interval ä¸å†è¿è¡Œ

B çš„æ§åˆ¶å°ä¸ä¼šå‡ºç° "CLIENT should not call applyDamage"

Step 3ï¼šè®© Host æ‰§è¡Œæ‰€æœ‰æ£‹å­çš„æ”»å‡»

æ£€æŸ¥ï¼š

B çš„æ£‹å­æ˜¯å¦çœŸçš„åœ¨ Host çš„ boardPieces æ•°ç»„é‡Œ

Host æœ‰æ³¨å†Œ B è¿™æšæ£‹å­çš„ mover/tower attack timer

Host èƒ½æ£€æµ‹åˆ°æ•Œæ–¹æ£‹å­å¹¶æ‰“å‡ºä¼¤å®³

å®Œæˆæ ‡å¿—ï¼š

B çš„æ£‹å­å¯ä»¥æ‰“åŠ¨ A çš„å¡”ï¼ˆHost æ¨¡æ‹Ÿï¼‰

A çš„å¡”å¯ä»¥æ‰“å‡» B çš„æ£‹å­ï¼ˆHost æ¨¡æ‹Ÿï¼‰

Step 4ï¼šapplyDamage â†’ state_update

Host æ‰£è¡€åï¼š

postToParent('state_update', {
  event: 'damage',
  piece_id,
  hp
});


å®Œæˆæ ‡å¿—ï¼š

Client ç«¯ä¸ä¼šå†è°ƒç”¨ applyDamage

Client ç«¯ç”¨ applyDamageFromServer åŒæ­¥è¡€é‡

Step 5ï¼šhandleDeath â†’ state_update

Host æ­»äº¡åï¼š

postToParent('state_update', {
  event: 'death',
  piece_id
});


Clientï¼š

case 'death': handleDeathFromServer(...)


å®Œæˆæ ‡å¿—ï¼š

ä¸¤ç«¯çœ‹åˆ°ä¸€è‡´çš„æ­»äº¡

ä¸å­˜åœ¨ä¸€ç«¯æ­»ã€ä¸€ç«¯æ´»çš„é—®é¢˜

Step 6ï¼šç»Ÿä¸€ Game Over

Host æ‰§è¡Œï¼š

postToParent('state_update', {event:'game_over', winner:'a'});
battleSocket.close();


Clientï¼š

case 'game_over':
  showGameOverScreen();
  disableAllInput();


å®Œæˆæ ‡å¿—ï¼š

åŒç«¯åŒæ­¥ç»“æŸï¼Œæ¸¸æˆä¸å†ç»§ç»­å‘ WS æ¶ˆæ¯

ä¸ä¼šå‡ºç°â€œä¸€ç«¯è¿˜åœ¨ç©â€çš„æƒ…å†µ

Step 7ï¼ˆå¯é€‰ï¼‰ï¼šç»Ÿä¸€ ruler_move_request é€»è¾‘

Host æ¥æ”¶ B çš„è·¯å¾„è¯·æ±‚

Host æ‰§è¡Œåˆæ³•æ€§æ ¡éªŒ

Host è‡ªå·±ç§»åŠ¨ ruler

Host å‘ state_update: ruler_move

å®Œæˆæ ‡å¿—ï¼š

åŒç«¯çš„ ruler å®Œå…¨ä¸€è‡´

elixir æ¶ˆè€—å§‹ç»ˆä¸€è‡´

ğŸ§¨ æœ€ç»ˆæ€»ç»“ï¼ˆä¸€å¥è¯ï¼‰

ä½ ç°åœ¨çš„é—®é¢˜å°±æ˜¯ï¼šB çš„æ”»å‡»å’Œ deploy åœ¨è‡ªå·±çš„æœ¬åœ°ç®—äº†ï¼Œä½† Host ä¸çŸ¥é“ â†’ Host ä¸å¸® B æ‰“ä¼¤å®³ â†’ B ä¼¤å®³æ— æ•ˆã€‚

ä½ éœ€è¦çš„ä¸æ˜¯ä¿® bugï¼Œè€Œæ˜¯ï¼š

æŠŠæ‰€æœ‰æˆ˜æ–—é€»è¾‘ä» â€œå¤šå®¢æˆ·ç«¯æ‰§è¡Œâ€ åˆå¹¶åˆ° â€œHost ç«¯å”¯ä¸€æ‰§è¡Œâ€ã€‚

## è¡ŒåŠ¨æ¸…å•ï¼ˆåŸºäºå½“å‰ä»£ç ï¼‰

- é˜»æ–­ Client æœ¬åœ°ä¸‹å­ï¼š`website/cat_royale/piece_deploy/piece_deploy.js` çš„ `deployPiece` é¡¶éƒ¨å¢åŠ  `if (!fromNetwork && window.IS_HOST !== true) return { requested: true };`ï¼Œåªè®© `handleLocalDeployRequest` èµ°ç½‘ç»œï¼›ç¡®ä¿ `fromNetwork` ç”Ÿæˆçš„æ£‹å­å¸¦ `skipElixir`ã€‚
- åªåœ¨ Host è·‘æ”»å‡»/å·¡æ£€ï¼š`scanTowerAttacks` è®¡æ—¶å™¨åˆ›å»ºå‰åŠ  `if (window.IS_HOST !== true) return;`ï¼›`startAggressiveTowerAttack`ã€`startSolidTowerAttack`ã€`startShouterAttack`ã€å…¶ä»–æ”»å‡»/ç§»åŠ¨è®¡æ—¶å‡½æ•°éƒ½åŠ  `if (window.IS_HOST !== true) return;`ï¼Œé˜²æ­¢ B è‡ªå·±æ‰£è¡€ã€‚
- ç»Ÿä¸€ä¼¤å®³å¹¿æ’­ï¼š`applyDamage` ä»åªå…è®¸è¿è¡Œåœ¨ Hostï¼Œç¡®è®¤æ¯æ¬¡æ‰£è¡€å¿…å‘é€ `state_update damage`ï¼›å®¢æˆ·ç«¯åªç”¨ `applyDamageFromServer` æ›´æ–°è¡€æ¡ã€‚
- ç»Ÿä¸€æ­»äº¡å¹¿æ’­ï¼š`handleDeath` ä»… Host è°ƒç”¨æ—¶å‘é€ `state_update death`ï¼›å®¢æˆ·ç«¯é€šè¿‡ `handleDeathFromServer` è½åœ°ï¼Œé¿å…åŒä¾§ä¸åŒæ­¥ã€‚
- Ruler ç§»åŠ¨æƒå¨ï¼šåœ¨ `website/cat_royale/game_page/index.js` çš„ parent bridge å¢åŠ  `ruler_move_request` å¤„ç†ï¼ŒHost éªŒè¯åæœ¬åœ°ç§»åŠ¨å¹¶å¹¿æ’­ `state_update`ï¼ˆå®¢æˆ·ç«¯å¿½ç•¥æœ¬åœ°æ‰£ elixirï¼‰ï¼›åœ¨ `ruler_move.js` å¼€å¤´åŠ  `if (window.IS_HOST !== true) return;` é˜²æ­¢ B è‡ªå·±èµ°ã€‚
- è®¡æ—¶ä¸èµ„æºï¼š`startTimer`ã€`elixir` åªç”± Host å˜æ›´å¹¶é€šè¿‡ `state_update timer/elixir` ä¸‹å‘ï¼Œå®¢æˆ·ç«¯ä¸è‡ªå¢ï¼›å¿…è¦æ—¶åœ¨ ElixirManager å¯åŠ¨å‰åˆ¤æ–­ `window.IS_HOST`ã€‚
- Game Over åŒæ­¥ï¼šHost åœ¨ç‹å¡”æ­»äº¡åå‘é€ `state_update game_over` å¹¶å…³é—­ WSï¼›å®¢æˆ·ç«¯æ”¶åˆ°åç¦ç”¨è¾“å…¥/æç¤ºç»“æœã€‚
- æ ¸å¯¹èµ„äº§ä¸èƒ½åŠ›ï¼šå¯¹ç…§æœ¬åœ°ä¸çº¿ä¸Šé™æ€èµ„æº/ability è„šæœ¬ï¼Œç¡®ä¿åŒæ–¹åŠ è½½åŒä¸€ç‰ˆæœ¬ï¼ˆ`pieces_ability/*`, `moving/*`ï¼‰ï¼›å¦‚æœ‰æ–°å¢èƒ½åŠ›ï¼ŒHost æ‰§è¡Œé€»è¾‘ï¼ŒClient ä»…æ˜¾ç¤ºã€‚

