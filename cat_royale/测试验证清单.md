# Cat Royale Bug修复验证清单

## 修复状态确认
所有代码修改已完成并提交到代码库。以下是验证步骤：

### 1. B端攻击效果显示
**期望行为**: B端玩家应该能看到A端塔的攻击动画和弹道

**测试步骤**:
1. 开启两个浏览器窗口，一个作为A端（HOST），一个作为B端（CLIENT）
2. A端部署aggressive_tower或solid_tower
3. B端部署一个troop（如shouter）进入塔的攻击范围
4. 观察B端是否能看到：
   - Aggressive Tower: 旋转动画 + 🐔弹道
   - Solid Tower: 抖动动画 + 📱弹道

**检查代码位置**:
- `piece_deploy.js:461-469` - HOST广播tower_attack事件
- `piece_deploy.js:473-479` - HOST广播tower_attack_stop事件
- `game_page.html:1416-1436` - CLIENT处理tower_attack事件
- `aggressive_tower_attack.js:25,54` - visualOnly参数
- `solid_tower_attack.js:25,54` - visualOnly参数

**如果问题仍存在，检查**:
- 浏览器控制台是否有错误
- 网络面板中WebSocket是否正常传输tower_attack消息
- IS_HOST标志是否正确设置（A端=true，B端=false）

---

### 2. 塔类型转换血条比例
**期望行为**: 塔从solid切换到aggressive时，血条长度应该正确反映血量比例

**测试步骤**:
1. 部署一个solid_tower（最大血量1000）
2. 让塔受到一些伤害（例如降到800HP）
3. 使用塔切换技能切换为aggressive_tower（最大血量600）
4. 观察血条是否正确显示为满血状态（因为800/600 > 1，应显示为满）

**检查代码位置**:
- `game_page.html:1294-1327` - tower_switch分支重建血条逻辑

**如果问题仍存在，检查**:
- 控制台是否输出healthBar相关错误
- 检查AggressiveTowerHP和SolidTowerHP的createHealthBar函数是否存在
- 血条DOM元素是否被正确移除和重建

---

### 3. 主塔2x2显示
**期望行为**:
- A端主塔应占据 d1,d2,e1,e2 四个格子
- B端主塔应占据 d7,d8,e7,e8 四个格子

**测试步骤**:
1. 启动游戏
2. 打开浏览器开发者工具控制台
3. 查找日志: `[registerKingTowers] Created a king tower at rows=...`
4. 验证输出：
   - A端: `rows=6,7, cols=3,4`
   - B端: `rows=0,1, cols=3,4`
5. 尝试在d1,d2,e1,e2（A端）或d7,d8,e7,e8（B端）部署棋子，应该被阻止

**检查代码位置**:
- `game_page.html:1665-1707` - registerKingTowers函数
- `general.js:79-88` - isCellBlocked函数

**如果问题仍存在，检查**:
- 控制台中的registerKingTowers日志输出
- 使用开发者工具检查.king-anchor元素的gridRow和gridColumn CSS属性
- 检查boardPieces数组中是否有4个king_tower条目

---

### 4. 其他效果同步
**期望行为**: 所有游戏效果在两端同步显示

**已验证同步的效果**:
- ✅ Shouter/Squirmer/Ruler攻击（通过mover，仅HOST运行）
- ✅ 伤害数值同步（通过damage事件）
- ✅ 死亡同步（通过death事件）
- ✅ Elixir同步（通过elixir事件）

**注意**: Shouter/Squirmer/Ruler的攻击视觉效果在CLIENT端不会显示，这是设计决策（mover仅在HOST运行）。如需同步这些效果，需要参考塔攻击的实现方式添加类似的事件广播。

---

## 快速调试指南

### 检查WebSocket消息
```javascript
// 在浏览器控制台运行
window.battleSocket.addEventListener('message', (event) => {
  const msg = JSON.parse(event.data);
  if (msg.event === 'tower_attack' || msg.event === 'tower_attack_stop') {
    console.log('[DEBUG]', msg);
  }
});
```

### 检查HOST标志
```javascript
// 在浏览器控制台运行
console.log('IS_HOST:', window.IS_HOST);
console.log('GAME_SIDE:', window.GAME_SIDE);
console.log('MY_SIDE:', window.MY_SIDE);
```

### 检查boardPieces
```javascript
// 在浏览器控制台运行
console.table(window.pieceDeployment.boardPieces.map(p => ({
  id: p.id,
  type: p.type,
  position: `${p.position.row},${p.position.col}`,
  hp: p.hp,
  maxHP: p.maxHP
})));
```

---

## 如果问题仍然存在

请提供以下信息：
1. 具体是哪个问题仍然存在（1/2/3/4）？
2. 具体的复现步骤
3. 浏览器控制台的错误信息（如果有）
4. 网络面板中的WebSocket消息（如果相关）
5. 期望的行为 vs 实际的行为

这将帮助我更准确地定位和修复问题。
