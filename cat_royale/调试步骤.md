# Cat Royale Bug修复 - 调试步骤

我已经添加了详细的调试日志。现在请按照以下步骤测试：

## 准备工作

1. **清除浏览器缓存**（非常重要！）
   - Chrome/Edge: Ctrl+Shift+Delete → 勾选"缓存的图片和文件" → 清除
   - 或者使用隐身/无痕模式
   - 或者硬刷新：Ctrl+F5 (Windows) / Cmd+Shift+R (Mac)

2. **打开浏览器开发者工具**
   - F12 或 右键→检查
   - 切换到 Console 标签

## 测试1: 攻击效果同步

### A端（HOST）操作：
1. 创建游戏，等待B端加入
2. 双击选择塔类型，点击Ready
3. 部署一个塔（aggressive_tower或solid_tower）
4. 观察控制台

**期望看到的日志**：
```
[HOST] Broadcasting tower_attack: <tower_id> -> <target_id> <tower_type>
```

### B端（CLIENT）操作：
1. 加入游戏
2. 选择塔类型，点击Ready
3. 部署一个troop（如shouter）让它进入A端塔的攻击范围
4. 观察控制台

**期望看到的日志**：
```
[CLIENT] tower_attack received: {...}
[CLIENT] Starting visual attack: aggressive_tower attacker: <id> target: <id>
```

**如果没有看到日志**：
- 检查B端是否收到任何state_update消息
- 检查WebSocket连接状态
- 检查IS_HOST标志（A端应为true，B端应为false）

---

## 测试2: 血条比例修复

### 操作步骤：
1. 部署一个solid_tower（最大血量1000）
2. 让它受到伤害（假设降到800HP）
3. 点击塔切换按钮，切换为aggressive_tower（最大血量600）
4. 观察控制台和血条显示

**期望看到的日志**：
```
[tower_switch] Received: {...}
[tower_switch] Switching tower: <id> from solid_tower to aggressive hp: 800 maxHP: 600
[tower_switch] Updated stats - maxHP: 1000 -> 600 hp: 800
[tower_switch] Removed old healthBar
[tower_switch] Created new healthBar: success
[tower_switch] Updated healthBar to: 800
```

**期望的视觉效果**：
- 血条应该显示为满（因为800/600 > 1）
- 或者正确的比例显示

**如果血条仍然错误**：
- 检查是否有"Failed to create healthBar"警告
- 检查window.AggressiveTowerHP和window.SolidTowerHP是否存在
- 检查旧血条是否真的被移除

---

## 测试3: 主塔2x2显示

### 操作步骤：
1. 启动游戏
2. 立即查看控制台日志

**期望看到的日志**：
```
[registerKingTowers] Created a king tower at rows=6,7, cols=3,4, gridRow=..., gridCol=...
[registerKingTowers] Created b king tower at rows=0,1, cols=3,4, gridRow=..., gridCol=...
```

### 验证方法：
1. 在控制台运行：
```javascript
console.table(window.pieceDeployment.boardPieces.filter(p => p.type === 'king_tower').map(p => ({
  id: p.id,
  allegiance: p.allegiance,
  row: p.position.row,
  col: p.position.col
})));
```

**期望输出**：
- A端应该有4个king_tower：rows 6,7 cols 3,4
- B端应该有4个king_tower：rows 0,1 cols 3,4

2. 尝试在这些格子部署棋子，应该被阻止（invalid flash）

---

## 常见问题排查

### 问题1: 看不到任何调试日志
**可能原因**：
- 浏览器缓存未清除
- 文件未保存/未刷新
- 控制台过滤设置

**解决方法**：
- 硬刷新（Ctrl+F5）
- 检查控制台右上角的过滤器，确保没有过滤掉log
- 检查文件时间戳确认是最新的

### 问题2: CLIENT日志显示"piece not found"
**可能原因**：
- 客户端的boardPieces没有正确同步
- ID不匹配

**解决方法**：
在客户端控制台运行：
```javascript
console.table(window.pieceDeployment.boardPieces.map(p => ({
  id: p.id,
  type: p.type,
  allegiance: p.allegiance
})));
```
检查是否有对方的pieces

### 问题3: HOST没有广播消息
**可能原因**：
- window.IS_HOST不是true
- targetChanged条件不满足

**解决方法**：
在HOST端控制台运行：
```javascript
console.log('IS_HOST:', window.IS_HOST);
console.log('postToParent exists:', typeof window.postToParent);
```

---

## 收集调试信息

如果问题仍然存在，请提供：

1. **A端（HOST）控制台完整输出**（特别是带[HOST]标记的）
2. **B端（CLIENT）控制台完整输出**（特别是带[CLIENT]标记的）
3. **Network标签中的WebSocket消息**（筛选tower_attack）
4. **具体的复现步骤**

### 导出控制台日志：
- 在Console中右键 → Save as...
- 或者复制全部内容

### 查看WebSocket消息：
1. Network标签 → WS过滤器
2. 点击WebSocket连接
3. 切换到Messages标签
4. 查找包含"tower_attack"的消息

---

## 下一步

根据你提供的调试信息，我可以：
1. 确定是代码逻辑问题还是同步问题
2. 找出具体哪个环节出错
3. 提供针对性的修复方案

请运行测试并告诉我结果！
