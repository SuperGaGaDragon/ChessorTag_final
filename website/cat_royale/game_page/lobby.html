<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAT ROYALE - Lobby</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cc 60%, #ffeab0 100%);
            color: #1f2937;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
        }

        /* Logo in top-left */
        .logo-container {
            position: absolute;
            top: 32px;
            left: 32px;
            z-index: 40;
        }

        .logo-img {
            width: 200px;
            height: auto;
            display: block;
            border: 2mm solid #000;
            border-radius: 12px;
        }

        /* Bottom-right character (knight) */
        .knight-container {
            position: fixed;
            bottom: 0;
            right: 0;
            z-index: 20;
            padding: 0 40px 40px 0;
        }

        .knight-img {
            width: 200px;
            height: auto;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
        }

        /* Bottom-left character (rook) */
        .rook-container {
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 20;
            padding: 0 0 40px 40px;
        }

        .rook-img {
            width: 200px;
            height: auto;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
        }

        /* Audio bishop */
        .bishop-container {
            position: fixed;
            top: 24px;
            right: 32px;
            z-index: 45;
        }

        .bishop-img {
            width: 140px;
            height: 140px;
            object-fit: contain;
            filter: drop-shadow(2px 2px 6px rgba(0, 0, 0, 0.16));
            cursor: pointer;
        }

        /* Main content container */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
            z-index: 30;
            position: relative;
        }

        /* Shouter image */
        .shouter-image {
            width: 400px;
            height: 400px;
            object-fit: contain;
            margin-bottom: 40px;
            filter: drop-shadow(4px 4px 8px rgba(0, 0, 0, 0.1));
            border: 2mm solid #000;
            border-radius: 12px;
        }

        /* Title */
        .title {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 60px;
            color: #1f2937;
            cursor: pointer;
            transform-origin: 50% 50%;
        }

        .title-wobble {
            animation: wobbleTilt 0.8s ease-in-out;
        }

        @keyframes wobbleTilt {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-4deg); }
            50% { transform: rotate(4deg); }
            75% { transform: rotate(-2deg); }
            100% { transform: rotate(0deg); }
        }

        /* Button container */
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }

        /* Main buttons */
        .lobby-button {
            background: #ffffff;
            border: 3px solid #1f2937;
            border-radius: 12px;
            padding: 20px 40px;
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .lobby-button:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.15);
        }

        .lobby-button:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px rgba(0, 0, 0, 0.15);
        }

        .lobby-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Game ID input */
        .game-id-input {
            background: #ffffff;
            border: 3px solid #1f2937;
            border-radius: 12px;
            padding: 20px;
            font-size: 18px;
            font-weight: 500;
            color: #1f2937;
            text-align: center;
            font-family: monospace;
            letter-spacing: 2px;
        }

        /* Info text */
        .info-text {
            text-align: center;
            font-size: 16px;
            color: #6b7280;
            margin-top: 10px;
        }

        /* Loading screen */
        .loading-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(248, 249, 250, 0.95);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-screen.active {
            display: flex;
        }

        .loading-animation {
            position: relative;
            width: 400px;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loading-center-logo {
            position: absolute;
            width: 150px;
            height: 150px;
            z-index: 3;
        }

        .loading-ring {
            position: absolute;
            animation: rotate 3s linear infinite;
        }

        .loading-ring.outer {
            width: 350px;
            height: 350px;
            animation-direction: normal;
        }

        .loading-ring.inner {
            width: 250px;
            height: 250px;
            animation-direction: reverse;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 40px;
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Rotating cats around page center */
        .rotating-cats-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .rotating-cat {
            position: absolute;
            --cat-tilt: 0deg;
            width: 160px;
            height: 160px;
            object-fit: contain;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.15));
            animation: rotateAroundCenter 12s linear infinite, tiltSwing 4s ease-in-out infinite;
            animation-play-state: running, paused;
            pointer-events: auto;
            cursor: pointer;
            transition: transform 0.2s ease;
            left: 50%;
            top: 50%;
            margin-left: -80px;
            margin-top: -80px;
        }

        .rotating-cat:hover {
            transform: scale(1.2) !important;
        }

        .tilt-on .rotating-cat {
            animation-play-state: running, running;
        }

        @keyframes rotateAroundCenter {
            0% {
                transform: rotate(0deg) translateX(350px) rotate(0deg) rotate(var(--cat-tilt));
            }
            100% {
                transform: rotate(360deg) translateX(350px) rotate(-360deg) rotate(var(--cat-tilt));
            }
        }

        /* Cat meow speech bubble */
        .cat-meow-bubble {
            position: fixed;
            background: #fffef5;
            border: 3px solid #1f2937;
            border-radius: 20px;
            padding: 16px 22px;
            font-size: 17px;
            color: #1f2937;
            font-weight: 700;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.15);
            z-index: 50;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            max-width: 280px;
            text-align: center;
            line-height: 1.4;
        }

        .cat-meow-bubble.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Swinging images */
        .swing-card {
            position: fixed;
            width: 220px;
            height: 220px;
            border: 3px solid #2563eb;
            border-radius: 16px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.15);
            transform-origin: 50% 100%;
            animation: swing 2s ease-in-out infinite;
            z-index: 35;
            cursor: pointer;
        }

        .swing-card.left {
            left: 32px;
            bottom: 160px;
        }

        .swing-card.right {
            right: 32px;
            bottom: 160px;
        }

        .swing-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        /* Swing effect reuse */
        .swing-active {
            animation: swing 2s ease-in-out infinite;
            transform-origin: 50% 100%;
        }

        @keyframes swing {
            0% { transform: rotate(-45deg); }
            50% { transform: rotate(45deg); }
            100% { transform: rotate(-45deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
        @keyframes rotateAroundCenter {
            0% {
                transform: rotate(0deg) translateX(250px) rotate(0deg) rotate(var(--cat-tilt));
            }
            100% {
                transform: rotate(360deg) translateX(250px) rotate(-360deg) rotate(var(--cat-tilt));
            }
        }

            .rotating-cat {
                width: 120px;
                height: 120px;
                margin-left: -60px;
                margin-top: -60px;
            }
        }

        @media (max-width: 480px) {
        @keyframes rotateAroundCenter {
            0% {
                transform: rotate(0deg) translateX(175px) rotate(0deg) rotate(var(--cat-tilt));
            }
            100% {
                transform: rotate(360deg) translateX(175px) rotate(-360deg) rotate(var(--cat-tilt));
            }
        }

        @keyframes tiltSwing {
            0% { --cat-tilt: 15deg; }
            25% { --cat-tilt: 15deg; }
            35% { --cat-tilt: -15deg; }
            60% { --cat-tilt: -15deg; }
            70% { --cat-tilt: 15deg; }
            100% { --cat-tilt: 15deg; }
        }

            .rotating-cat {
                width: 100px;
                height: 100px;
                margin-left: -50px;
                margin-top: -50px;
            }
        }
    </style>
</head>
<body>
    <!-- Rotating cats container -->
    <div class="rotating-cats-container" id="rotatingCatsContainer"></div>

    <!-- Meow speech bubble -->
    <div class="cat-meow-bubble" id="meowBubble">Meow!</div>

    <!-- Swinging loading images -->
    <div class="swing-card left" id="swingLeft">
        <img src="../../assets/loading3.png" alt="Loading Left" class="swing-img">
    </div>
    <div class="swing-card right" id="swingRight">
        <img src="../../assets/loading4.png" alt="Loading Right" class="swing-img">
    </div>

    <!-- Logo -->
    <div class="logo-container">
        <img src="../../assets/logo2.png" alt="Logo" class="logo-img">
    </div>

    <!-- Bottom-left character (rook) -->
    <div class="rook-container">
        <img src="../pieces/ruler/ruler.png" alt="Rook" class="rook-img">
    </div>

    <!-- Bottom-right character (knight) -->
    <div class="knight-container">
        <img src="../pieces/fighter/fighter.png" alt="Knight" class="knight-img">
    </div>

    <!-- Audio-trigger black bishop -->
    <div class="bishop-container">
        <img src="../../assets/cat_pieces/black_bishop.png" alt="Black Bishop" class="bishop-img" id="audioBishop">
    </div>

    <!-- Main Lobby Page -->
    <div id="mainLobby" class="main-container">
        <img src="../pieces/shouter/shouter_board.png" alt="Shouter" class="shouter-image">
        <h1 class="title">CAT ROYALE | By Cata Dragon & Chess Nut</h1>
        <div class="button-container">
            <button class="lobby-button" onclick="createGame()">Start a game</button>
            <button class="lobby-button" onclick="joinGame()">Join a game</button>
            <button class="lobby-button" disabled>Custom game （敬请期待）</button>
        </div>
    </div>

    <!-- Create Game Page -->
    <div id="createGamePage" class="main-container hidden">
        <img src="../pieces/shouter/shouter_board.png" alt="Shouter" class="shouter-image">
        <h1 class="title">CAT ROYALE | By Cata Dragon & Chess Nut</h1>
        <div class="button-container">
            <button class="lobby-button" id="copyGameIdBtn" onclick="copyGameId()">Copy game ID</button>
            <div class="game-id-input" id="gameIdDisplay">Loading...</div>
            <button class="lobby-button hidden" id="startGameBtn" onclick="startGame()">Click to Start</button>
            <p class="info-text">Share the game ID with your opponent</p>
        </div>
    </div>

    <!-- Join Game Page -->
    <div id="joinGamePage" class="main-container hidden">
        <img src="../pieces/shouter/shouter_board.png" alt="Shouter" class="shouter-image">
        <h1 class="title">CAT ROYALE | By Cata Dragon & Chess Nut</h1>
        <div class="button-container">
            <input type="text" class="game-id-input" id="gameIdInput" placeholder="Enter Game ID" maxlength="6">
            <button class="lobby-button" onclick="joinWithId()">Join Game</button>
            <button class="lobby-button hidden" id="joinStartGameBtn" onclick="startGame()">Click to Start</button>
            <p class="info-text">Enter the game ID to join</p>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-animation">
            <img src="../../assets/logo2.png" alt="Logo" class="loading-center-logo">
            <img src="../../assets/loading4.png" alt="Loading Outer" class="loading-ring outer">
            <img src="../../assets/loading3.png" alt="Loading Inner" class="loading-ring inner">
        </div>
        <div class="loading-text">Waiting for opponent...</div>
    </div>

    <script>
        // All cat pieces and loading images
        const catPieces = [
            '../../assets/cat_pieces/King.png',
            '../../assets/cat_pieces/Knight.png',
            '../../assets/cat_pieces/Queen.png',
            '../../assets/cat_pieces/Rook.png',
            '../../assets/cat_pieces/black_bishop.png',
            '../../assets/cat_pieces/black_pawn.png',
            '../../assets/cat_pieces/white_bishop.png',
            '../../assets/cat_pieces/pawn.png',
            '../../assets/cat_pieces/folder1.png',
            '../../assets/cat_pieces/folder2.png',
            '../../assets/cat_pieces/folder3.png',
            '../../assets/cat_pieces/folder4.png',
            '../../assets/cat_pieces/folder5.png',
            '../../assets/loading3.png',
            '../../assets/loading4.png'
        ];

        // Morandi color palette
        const morandiPalette = [
            { base: '#f3e7d1', top: '#f9f0de' },
            { base: '#f1e4de', top: '#f7ede7' },
            { base: '#e6e0d8', top: '#f0e8df' },
            { base: '#e0ddd6', top: '#e9e5dd' },
            { base: '#dcd9d2', top: '#e6e3dc' },
            { base: '#d8d5cc', top: '#e2dfd6' },
            { base: '#d6d8df', top: '#e1e3ea' },
            { base: '#d5dde3', top: '#e0e7ec' },
            { base: '#d6e3e1', top: '#e0ecea' },
            { base: '#dbe6d9', top: '#e6efe4' },
            { base: '#e7ead6', top: '#f2f5df' },
            { base: '#e9e0d3', top: '#f3e9dc' },
            { base: '#e2d8e0', top: '#ece1e9' },
            { base: '#dcd7e6', top: '#e7e2ef' },
            { base: '#d8dbe9', top: '#e3e6f3' },
            { base: '#d9e0ed', top: '#e3e8f4' },
            { base: '#d9e5f0', top: '#e3eef8' },
            { base: '#dae8e6', top: '#e4f1ef' },
            { base: '#e3e9de', top: '#edf3e8' },
            { base: '#e9e5d8', top: '#f3efe2' },
        ];

        // Cat messages
        const catMessages = [
            "Meow!",
            "Welcome!",
            "Join us!",
            "Ga Ga Ga!",
            "Let's play!",
            "I made this game myself",
            "I love cat cans",
            "Could you plz give me some salmon",
            "I love sunshine",
            "I love flowers",
            "To be or not to be....",
            "You never know dear~ how much I love you~",
            "I am a loyal fan of Khalil Fong.",
            "Katrina, I can't stop looking in your eyes~",
            "Oh It's a singalong song~ It's not so long~",
            "天青色等烟雨，而我在等你～",
            "Shall I compare thee to a summer day?",
            "A thing of beauty is a joy forever"
        ];

        const rotatingCatsContainer = document.getElementById('rotatingCatsContainer');
        const meowBubble = document.getElementById('meowBubble');
        const swingCards = document.querySelectorAll('.swing-card');
        const titles = document.querySelectorAll('.title');
        const logoImg = document.querySelector('.logo-img');
        const shouterImgs = document.querySelectorAll('.shouter-image');
        const bishopImg = document.getElementById('audioBishop');
        const swingableTargets = [logoImg, bishopImg, ...shouterImgs].filter(Boolean);
        const backgroundThemes = [
            'linear-gradient(135deg, #fff9e6 0%, #fff3cc 60%, #ffeab0 100%)', // soft yellow
            'linear-gradient(135deg, #f4f0ff 0%, #ede6fa 60%, #e4ddf4 100%)', // soft purple
            'linear-gradient(135deg, #eef7ff 0%, #e4f1fb 60%, #d8e7f5 100%)', // soft blue
            'linear-gradient(135deg, #fff1f4 0%, #fde8ee 60%, #f8dfe7 100%)'  // soft pink
        ];
        let currentBackgroundIndex = 0;

        // Audio setup
        const audioTracks = [
            'BB88.mp3',
            'Hey_Jude.mp3',
            '好汉歌.mp3',
            '龙拳.mp3',
            '讨厌红楼梦.mp3',
            '每个人都会.mp3',
            '蜜雪冰城.mp3'
        ];
        const audioBasePath = '../cr_assets/audios/';
        let audioPlayer = null;
        let currentTrack = null;
        let currentIndex = -1;
        let isAudioPlaying = false;

        // Create rotating cats
        function createRotatingCats() {
            const totalCats = catPieces.length; // 15 cats
            const animationDuration = 12; // 12 seconds for full rotation
            const degreesPerCat = 360 / totalCats; // 24 degrees between each cat
            const secondsPerDegree = animationDuration / 360; // 0.0333s per degree

            catPieces.forEach((catSrc, index) => {
                const cat = document.createElement('img');
                cat.className = 'rotating-cat';
                cat.src = catSrc;
                cat.alt = 'Cat';

                // Calculate delay for even distribution
                // Each cat should be offset by (index * degreesPerCat) degrees
                // Negative delay because we want them to start at different points in the rotation
                const delay = -(index * degreesPerCat * secondsPerDegree);
                cat.style.animationDelay = `${delay}s, 0s`;

                // Click handler for meow
                cat.addEventListener('click', (e) => {
                    showMeow(e.clientX, e.clientY);
                });

                rotatingCatsContainer.appendChild(cat);
            });
        }

        // Show meow bubble
        function showMeow(x, y) {
            const bubbleWidth = 250;
            const bubbleHeight = 60;

            // Random message
            const randomMessage = catMessages[Math.floor(Math.random() * catMessages.length)];
            meowBubble.textContent = randomMessage;

            // Random Morandi color
            const randomColor = morandiPalette[Math.floor(Math.random() * morandiPalette.length)];
            meowBubble.style.background = randomColor.base;
            meowBubble.style.borderColor = '#1f2937';

            // Position bubble near click with some offset
            const offsetX = Math.random() > 0.5 ? 60 : -280;
            const offsetY = Math.random() > 0.5 ? 60 : -120;

            let bubbleX = x + offsetX;
            let bubbleY = y + offsetY;

            // Keep bubble in viewport
            bubbleX = Math.max(20, Math.min(bubbleX, window.innerWidth - bubbleWidth - 20));
            bubbleY = Math.max(20, Math.min(bubbleY, window.innerHeight - bubbleHeight - 20));

            meowBubble.style.left = bubbleX + 'px';
            meowBubble.style.top = bubbleY + 'px';

            meowBubble.classList.add('show');

            // Hide after 2 seconds
            setTimeout(() => {
                meowBubble.classList.remove('show');
            }, 2000);
        }

        // Set up swinging cards
        function setupSwingCards() {
            swingCards.forEach((card) => {
                const baseDuration = 2;
                card.dataset.duration = baseDuration.toString();
                card.dataset.clickCount = '0';
                card.style.animationDuration = `${baseDuration}s`;

                card.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const current = parseFloat(card.dataset.duration) || baseDuration;
                    const next = +(current * 0.8).toFixed(3);
                    const clicks = (parseInt(card.dataset.clickCount, 10) || 0) + 1;

                    if (clicks >= 10) {
                        card.dataset.duration = baseDuration.toString();
                        card.style.animationDuration = `${baseDuration}s`;
                        card.dataset.clickCount = '0';
                    } else {
                        card.dataset.duration = next.toString();
                        card.style.animationDuration = `${next}s`;
                        card.dataset.clickCount = clicks.toString();
                    }
                });
            });
        }

        // Title wobble on click
        function setupTitleWobble() {
            titles.forEach((title) => {
                title.addEventListener('click', () => {
                    title.classList.remove('title-wobble'); // restart animation
                    void title.offsetWidth; // force reflow
                    title.classList.add('title-wobble');
                });

                title.addEventListener('animationend', () => {
                    title.classList.remove('title-wobble');
                });
            });
        }

        function setupSwingableTargets() {
            const baseDuration = 2;

            swingableTargets.forEach((target) => {
                target.dataset.duration = baseDuration.toString();
                target.dataset.clickCount = '0';
                target.dataset.baseDuration = baseDuration.toString();

                target.addEventListener('click', () => {
                    if (!isAudioPlaying) return;
                    const base = parseFloat(target.dataset.baseDuration) || baseDuration;
                    const current = parseFloat(target.dataset.duration) || base;
                    const next = +(current * 0.8).toFixed(3);
                    const clicks = (parseInt(target.dataset.clickCount, 10) || 0) + 1;

                    if (clicks >= 10) {
                        target.dataset.duration = base.toString();
                        target.style.animationDuration = `${base}s`;
                        target.dataset.clickCount = '0';
                    } else {
                        target.dataset.duration = next.toString();
                        target.style.animationDuration = `${next}s`;
                        target.dataset.clickCount = clicks.toString();
                    }
                });
            });
        }

        function updateSwingState(active) {
            swingableTargets.forEach((target) => {
                const base = parseFloat(target.dataset.baseDuration) || 2;

                if (active) {
                    const duration = target.dataset.duration ? parseFloat(target.dataset.duration) : base;
                    target.style.animationDuration = `${duration}s`;
                    target.classList.add('swing-active');
                } else {
                    target.classList.remove('swing-active');
                    target.dataset.duration = base.toString();
                    target.dataset.clickCount = '0';
                    target.style.animationDuration = '';
                }
            });
        }

        function updateCatTiltState(active) {
            rotatingCatsContainer.classList.toggle('tilt-on', active);
        }

        function setBackground(index) {
            if (!backgroundThemes.length) return;
            const nextIndex = ((index % backgroundThemes.length) + backgroundThemes.length) % backgroundThemes.length;
            currentBackgroundIndex = nextIndex;
            document.body.style.background = backgroundThemes[nextIndex];
        }

        function isBackgroundClick(event) {
            const ignoreSelector = '.lobby-button, .game-id-input, .swing-card, .rotating-cat, .bishop-container, .logo-container, .shouter-image, .title, .rook-container, .knight-container, #meowBubble';
            if (event.target.closest(ignoreSelector)) return false;
            const tag = event.target.tagName;
            if (['BUTTON', 'INPUT', 'TEXTAREA', 'A', 'SELECT', 'OPTION', 'LABEL'].includes(tag)) return false;
            return true;
        }

        function setupBackgroundCycle() {
            setBackground(currentBackgroundIndex);
            document.body.addEventListener('click', (event) => {
                if (!isBackgroundClick(event)) return;
                setBackground(currentBackgroundIndex + 1);
            });
        }

        function setupAudioBishop() {
            if (!bishopImg) return;

            audioPlayer = new Audio();
            audioPlayer.addEventListener('ended', () => {
                isAudioPlaying = false;
                updateSwingState(false);
                updateCatTiltState(false);
            });

            let clickTimer = null;

            bishopImg.addEventListener('click', (event) => {
                // Prevent immediate stop from dblclick
                if (event.detail > 1) return;

                clearTimeout(clickTimer);
                clickTimer = setTimeout(() => {
                    if (currentTrack === null) {
                        playRandomStartTrack();
                    } else {
                        playNextTrack();
                    }
                }, 200);
            });

            bishopImg.addEventListener('dblclick', () => {
                clearTimeout(clickTimer);
                stopAudio();
            });
        }

        function playRandomStartTrack() {
            if (!audioPlayer || !audioTracks.length) return;
            const idx = Math.floor(Math.random() * audioTracks.length);
            currentIndex = idx;
            const track = audioTracks[idx];
            playTrack(track);
        }

        function playNextTrack() {
            if (!audioPlayer) return;
            if (!audioTracks.length) return;

            currentIndex = (currentIndex + 1) % audioTracks.length;
            const track = audioTracks[currentIndex];
            playTrack(track);
        }

        function playTrack(trackName) {
            if (!audioPlayer) return;

            const startOffsets = {
                'BB88.mp3': 28,
                '龙拳.mp3': 26
            };

            const encoded = encodeURIComponent(trackName);
            const src = `${audioBasePath}${encoded}`;
            const startTime = startOffsets[trackName] || 0;

            audioPlayer.pause();
            audioPlayer.src = src;
            currentTrack = trackName;

            const handleMetadata = () => {
                audioPlayer.removeEventListener('loadedmetadata', handleMetadata);
                if (startTime > 0) {
                    audioPlayer.currentTime = startTime;
                }
                audioPlayer.play().then(() => {
                    isAudioPlaying = true;
                    updateSwingState(true);
                    updateCatTiltState(true);
                }).catch((err) => {
                    console.error('Audio play error:', err);
                });
            };

            audioPlayer.addEventListener('loadedmetadata', handleMetadata);
            audioPlayer.load();
        }

        function stopAudio() {
            if (!audioPlayer) return;
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            isAudioPlaying = false;
            currentTrack = null;
            currentIndex = -1;
            updateSwingState(false);
            updateCatTiltState(false);
        }

        // Initialize rotating cats
        createRotatingCats();
        setupSwingCards();
        setupSwingableTargets();
        setupAudioBishop();
        setupTitleWobble();
        setupBackgroundCycle();
    </script>

    <script>
        let currentGameId = null;
        let currentSide = null;
        let isHost = false;
        let opponentReady = false;
        let selfReady = false;

        // API base URL
        const API_BASE = window.location.hostname === 'chessortag.org' || window.location.hostname === 'www.chessortag.org'
            ? 'https://api.chessortag.org'
            : 'http://localhost:3000';
        const BATTLE_API = `${API_BASE}/api/battle`;

        // Show/hide pages
        function showPage(pageId) {
            document.getElementById('mainLobby').classList.add('hidden');
            document.getElementById('createGamePage').classList.add('hidden');
            document.getElementById('joinGamePage').classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
        }

        // Create a new game
        async function createGame() {
            try {
                const response = await fetch(`${BATTLE_API}/create`, { method: 'POST' });
                const data = await response.json();

                if (data.game_id || data.gameId) {
                    currentGameId = (data.game_id || data.gameId).toUpperCase();
                    currentSide = (data.side || 'a').toLowerCase();
                    isHost = true;

                    document.getElementById('gameIdDisplay').textContent = currentGameId;
                    showPage('createGamePage');

                    // Start polling for opponent
                    pollGameState();
                } else {
                    alert('Failed to create game');
                }
            } catch (error) {
                console.error('Error creating game:', error);
                alert('Failed to create game');
            }
        }

        // Join game page
        function joinGame() {
            showPage('joinGamePage');
        }

        // Join with game ID
        async function joinWithId() {
            const gameId = document.getElementById('gameIdInput').value.trim().toUpperCase();

            if (!gameId || gameId.length !== 6) {
                alert('Please enter a valid 6-character game ID');
                return;
            }

            try {
                const response = await fetch(`${BATTLE_API}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ game_id: gameId })
                });

                const data = await response.json();

                if (data.side) {
                    currentGameId = (data.game_id || gameId).toUpperCase();
                    currentSide = data.side.toLowerCase();
                    isHost = false;

                    // Joiner goes straight to game
                    startGameNow();
                } else {
                    alert(data.error || 'Failed to join game');
                }
            } catch (error) {
                console.error('Error joining game:', error);
                alert('Failed to join game');
            }
        }

        // Copy game ID to clipboard
        function copyGameId() {
            if (currentGameId) {
                navigator.clipboard.writeText(currentGameId).then(() => {
                    const btn = document.getElementById('copyGameIdBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                });
            }
        }

        // Poll game state
        async function pollGameState() {
            if (!currentGameId) return;

            try {
                const response = await fetch(`${BATTLE_API}/game_info?game=${encodeURIComponent(currentGameId)}`);
                const data = await response.json();

                // Host waits for player B to arrive, then can start
                if (isHost && data.has_player_b) {
                    document.getElementById('startGameBtn').classList.remove('hidden');
                }

                // If both sides present, auto-start after brief delay
                if (data.has_player_a && data.has_player_b) {
                    setTimeout(() => {
                        startGameNow();
                    }, 500);
                    return;
                }

                // Continue polling
                setTimeout(pollGameState, 1000);
            } catch (error) {
                console.error('Error polling game state:', error);
                setTimeout(pollGameState, 2000);
            }
        }

        // Click to start
        async function startGame() {
            if (!currentGameId) return;
            startGameNow();
        }

        // Start the actual game
        function startGameNow() {
            // Redirect to game page
            const sideParam = currentSide ? `&side=${encodeURIComponent(currentSide)}` : '';
            window.location.href = `game_page.html?game=${encodeURIComponent(currentGameId)}${sideParam}`;
        }
    </script>
</body>
</html>
