<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chessortag – New report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --green: #22c55e;
      --bg: #f8f9fa;
      --text-main: #1f2937;
      --text-sub: #4b5563;
      --card-bg: #ffffff;
      --border-soft: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .topbar {
      height: 56px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-soft);
      background: var(--card-bg);
    }
    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-mark {
      width: 30px;
      height: 30px;
      border-radius: 10px;
      border: 2px solid var(--green);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--green);
    }
    .logo-text {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-main);
    }
    .top-links {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--text-sub);
    }
    .top-links a {
      color: var(--text-sub);
      text-decoration: none;
    }
    .top-links a:hover {
      color: var(--text-main);
    }
    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      display: inline-block;
    }

    main {
      flex: 1;
      padding: 18px 18px 24px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .shell {
      max-width: 960px;
      width: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 16px;
    }

    .hero-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-main);
    }
    .hero-sub {
      margin-top: 4px;
      font-size: 13px;
      color: var(--text-sub);
    }

    .card {
      border-radius: 20px;
      border: 1px solid var(--border-soft);
      background: var(--card-bg);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      padding: 18px 18px 16px;
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 18px;
    }

    .preview-box {
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      min-height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-sub);
      font-size: 13px;
      text-align: center;
      padding: 12px;
      position: relative;
      overflow: hidden;
    }
    .preview-logo {
      width: 64px;
      height: 64px;
      border-radius: 20px;
      border: 2px solid var(--green);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 34px;
      color: var(--green);
      margin-bottom: 8px;
    }
    .preview-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .preview-caption {
      font-size: 12px;
      color: var(--text-sub);
    }

    .steps {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .step-row {
      display: grid;
      grid-template-columns: 22px 1fr;
      gap: 8px;
      align-items: flex-start;
      font-size: 13px;
    }
    .step-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      margin-top: 2px;
      color: var(--text-sub);
      background: #f9fafb;
    }
    .step-icon.done {
      border-color: var(--green);
      background: var(--green);
      color: #ffffff;
    }
    .step-title {
      font-weight: 500;
      color: var(--text-main);
    }
    .step-desc {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 1px;
    }

    .upload-row {
      margin-top: 14px;
      display: grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1.2fr);
      gap: 12px;
      font-size: 12px;
    }

    .upload-col {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      padding: 10px 10px 12px;
      display: grid;
      gap: 8px;
    }
    .upload-col-title {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 2px;
      color: var(--text-main);
    }
    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: var(--text-main);
      padding: 8px;
      font-size: 12px;
      resize: vertical;
    }
    input[type="file"] {
      font-size: 11px;
      color: var(--text-sub);
    }

    .btn-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
    }
    .btn.primary {
      border-color: var(--green);
      background: var(--green);
      color: #ffffff;
    }
    .btn.primary:hover {
      background: #16a34a;
    }
    .btn.ghost:hover {
      background: #f3f4f6;
    }

    .status-line {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
    }

    .footer-note {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 6px;
      line-height: 1.4;
    }

    @media (max-width: 880px) {
      .card {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo-row">
      <div class="logo-mark">C</div>
      <div class="logo-text">Chessortag</div>
    </div>
    <div class="top-links">
      <a href="index.html">About</a>
      <span>|</span>
      <a href="home.html">Home</a>
      <span>|</span>
      <span>New report</span>
      <span class="avatar"></span>
    </div>
  </header>

  <main>
    <div class="shell">
      <div>
        <div class="hero-title">New Chessortag report</div>
        <div class="hero-sub">
          Upload a PGN of your games, then let the backend generate a full style report (phase 2).
        </div>
      </div>

      <section class="card">
        <!-- 左边：report 封面预览 -->
        <div class="preview-box">
          <div class="preview-inner">
            <div class="preview-logo">F</div>
            <div>Chessortag report preview</div>
            <div class="preview-caption">
              Later this box shows your avatar, name and rating summary.<br/>
              For now it’s just a placeholder cover.
            </div>
          </div>
        </div>

        <!-- 右边：steps + 上传区域 -->
        <div>
          <div class="steps">
            <div class="step-row">
              <div class="step-icon done">1</div>
              <div>
                <div class="step-title">Upload PGN</div>
                <div class="step-desc">
                  Import one or more games (PGN file or copy/paste text). In the future this will support direct Lichess links.
                </div>
              </div>
            </div>
            <div class="step-row">
              <div class="step-icon">2</div>
              <div>
                <div class="step-title">Send to backend</div>
                <div class="step-desc">
                  FastAPI receives your games, runs the engine + style-tag pipeline and prepares the phase 2 report payload.
                </div>
              </div>
            </div>
            <div class="step-row">
              <div class="step-icon">3</div>
              <div>
                <div class="step-title">Open report</div>
                <div class="step-desc">
                  A new item will appear in <em>Your reports</em>. Click to view the full interactive style report.
                </div>
              </div>
            </div>
          </div>

          <div class="upload-row">
            <div class="upload-col">
              <div class="upload-col-title">Option A · Upload PGN file</div>
              <input id="pgnFileInput" type="file" accept=".pgn,.txt" />
              <div class="step-desc">
                We will send this PGN directly to the backend and create a study entry.
              </div>
            </div>
            <div class="upload-col">
              <div class="upload-col-title">Option B · Paste PGN</div>
              <textarea id="pgnTextInput" placeholder="Paste PGN here..."></textarea>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn primary" type="button" onclick="generateReport()">
              Generate report
            </button>
            <button class="btn ghost" type="button" onclick="fakeGenerate()">
              Generate report (demo mode)
            </button>
            <button class="btn ghost" type="button" onclick="useSample()">
              Use sample player: TestYuYaochen
            </button>
          </div>

          <div class="status-line" id="statusLine">
            Status: idle – waiting for PGN.
          </div>

          <div class="footer-note">
            This page sends your PGN to <code>/api/study/import_pgn</code> on the backend (default port 7000),
            stores it as a study entry, and then you can continue in <em>Home</em> or <em>Study board</em>.
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const statusLine = document.getElementById("statusLine");
    const pgnTextInput = document.getElementById("pgnTextInput");
    const pgnFileInput = document.getElementById("pgnFileInput");

    // 配置后端API地址 - 默认指向 7000 端口，可通过 ?api_base=... 或 window.STUDY_API_BASE 覆盖
    function resolveApiBase() {
      const queryBase = new URLSearchParams(window.location.search).get("api_base");
      const lsBase = window.localStorage.getItem("studyApiBase");
      const devFallback = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
        ? ((window.location.port === "4000" || window.location.port === "3000") ? "http://localhost:7000" : null)
        : null;
      return (
        (window.STUDY_API_BASE && window.STUDY_API_BASE.trim()) ||
        (queryBase && queryBase.trim()) ||
        (lsBase && lsBase.trim()) ||
        devFallback ||
        (window.location.port ? window.location.origin : null) ||
        "http://localhost:7000"
      );
    }
    const API_BASE_URL = resolveApiBase();
    statusLine.textContent = `Status: idle – waiting for PGN (API ${API_BASE_URL}).`;

    // 真实的生成报告函数
    async function generateReport() {
      // 1. 获取PGN数据
      let pgnContent = '';
      const hasText = pgnTextInput.value.trim().length > 0;
      const hasFile = pgnFileInput.files && pgnFileInput.files.length > 0;

      if (!hasText && !hasFile) {
        alert("Please upload a PGN file or paste PGN text first.");
        return;
      }

      // 优先使用文本输入
      if (hasText) {
        pgnContent = pgnTextInput.value.trim();
      } else if (hasFile) {
        try {
          pgnContent = await readFileContent(pgnFileInput.files[0]);
        } catch (error) {
          statusLine.textContent = "Error: Failed to read file - " + error.message;
          return;
        }
      }

      // 2. 发送到后端
      statusLine.textContent = `Status: Sending PGN to backend at ${API_BASE_URL}...`;
      window.localStorage.setItem("studyApiBase", API_BASE_URL);

      try {
        const response = await fetch(`${API_BASE_URL}/api/study/import_pgn`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pgn: pgnContent,
            title: "Imported from new_report.html",
            source: "user_upload",
            owner_id: "demo-user",
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        const studyId = result.study_id || "(unknown id)";
        const moveCount = (result.san_moves && result.san_moves.length) || 0;
        statusLine.textContent = `Status: Study created (${studyId}, ${moveCount} moves). Backend: ${API_BASE_URL}`;

        // 3. 成功后重定向到home页面
        setTimeout(() => {
          window.location.href = 'home.html';
        }, 1500);

      } catch (error) {
        statusLine.textContent = `Status: Error - ${error.message}`;
        console.error('Error generating report:', error);
      }
    }

    // 读取文件内容的辅助函数
    function readFileContent(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });
    }

    // Demo函数 - 用于测试UI
    function fakeGenerate() {
      const hasText = pgnTextInput.value.trim().length > 0;
      const hasFile = pgnFileInput.files && pgnFileInput.files.length > 0;
      if (!hasText && !hasFile) {
        alert("Please upload a PGN file or paste PGN text first.");
        return;
      }
      statusLine.textContent = "Status: demo mode – skipped backend call. Use the green button for real import.";
    }

    function useSample() {
      pgnTextInput.value = "1. e4 e5 2. Nf3 Nc6 3. Bb5 a6";
      statusLine.textContent = "Status: sample PGN loaded – click Generate report to import to backend.";
    }
  </script>
</body>
</html>
